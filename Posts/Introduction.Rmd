---
title: "Introduction: Welcome to the Blog"
author: "Samuel Thau"
date: "9/9/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(usmap)

## read in state pop vote
pvstate_df <- read_csv("../Data/popvote_bystate_1948-2016.csv")
pvstate_df$full <- pvstate_df$state

## shapefile of states from `usmap` library
## note: `usmap` merges this internally, but other packages may not!
states_map <- usmap::us_map()
```

## Introduction

Before we get into prediction, it will be helpful to get some background on the history of electionis in the United States. Let's start with a relatively simple question: how do election results change year to year? There are several ways to measure the results of an election:

1. Popular vote share - this is what most people think of as the "popular vote." 
2. Two party popular vote share - this exculdes third party candidates. This excludes third party candidates, which rarely have an impact on the election (though in close elections, or in select cases, this can be quite different from the popular vote share)
3. Electoral votes - awarded on a state by state basis, this is what candidates have to win to win the presidency. Predicting the electoral college, instead of the popular vote share, is more somewhat more complex because it happens at the state by state level. 

## Vote Share
Because the presidential election is determined on a state by state basis, it's good to start looking at some maps. For now, I'll stick to the two party vote share, becuase intuitively that's what matters for election outcomes; because of the weakness of third party campaigns since WWII (though there are some exceptions), whoever wins between the Republican and Democrat almost always wins the state. 

```{r margins, echo=FALSE, warning = FALSE, results = FALSE}
pv_margins_map <- pvstate_df %>%
  filter(year >= 1972) %>%
  mutate(win_margin = (R_pv2p-D_pv2p))

# Find max vote shares to set bounds
pv_margins_map[which.max(pv_margins_map$win_margin),]
pv_margins_map[which.min(pv_margins_map$win_margin),]

plot_usmap(data = pv_margins_map, regions = "states", values = "win_margin") +
  facet_wrap(facets = year ~.) + ## specify a grid by year
  scale_fill_gradient2(
    high = "red", 
    mid = "white",
    low = "blue", 
    breaks = c(-75,-50,-25,0,25,50,75), 
    limits = c(-75,75),
    name = "Win Margin (Percentage Points)"
  ) +
  theme_void() +
  theme(strip.text = element_text(size = 12),
        aspect.ratio=1) + 
  labs(title = "Vote Margins By State and Year For US Presidential Elections",
              caption = "Positive margins are wins for Republicans, negative for Democrats.") +
    theme(plot.title = element_text(face="bold"))

```

Looking at the vote shares over time can be deceptive: in every state but Nebraska and Maine, states operate on a winner take all basis, so this last graphic does not tell the full story. For example, in 1972, **Richard Nixon** beat **George McGovern** by `59.9` percentage points in Mississippi, meaning that if **185k people** switched their votes from Nixon to McGovern, Nixon *still* would have won Mississippi. Looking at who actually won the states may paint a clearer picture of electoral trends over time. 

```{r winner, echo=FALSE, warning = FALSE, results = FALSE}
pv_map_grid <- pvstate_df %>%
  filter(year >= 1972) %>%
  mutate(winner = ifelse(R > D, "Republican", "Democrat"))

plot_usmap(data = pv_map_grid, regions = "states", values = "winner", color = "white") +
  facet_wrap(facets = year ~.) + ## specify a grid by year
  scale_fill_manual(values = c("blue", "red"), name = "Popular Vote Winner") +
  theme_void() +
  theme(strip.text = element_text(size = 12),
        aspect.ratio=1) +
  labs(title =  "Popular Vote Winners by State and Year") +
    theme(plot.title = element_text(face="bold"))
```

There are a lot of different conclusions that can be drawn from the winner take all graphic, many of which I'm excited to explore as the class continues. For example, certain states have remained remarkably consistent in which party they vote for: Texas has not voted for a Democrat since 1976, and Minnesota has not voted for a Republican since 1972. This phenomenon may be the result of many possible outcomes: political polarization, relatively low migration combinded with demographic preferences, economic trends (based on industry),  and many other possibilities. It is difficult to determine which (if any) of these factors play a major role, so further investigation over the course of the semester is neccessary. 


## Tipping Point States
The combination of the electoral college and looking at the vote share over time begs a question: which states matter to decide elections? To do this, I'll use the idea of a tipping point state. 

A **tipping point state** is a state that puts a candidate over the 270 electoral vote threshold. To figure out which state this is, we order the states by net vote share. For example, in 2016 <insert state here> voted for overwhelmingly for Trump with <percent of the vote>, so that would be the first state in the list. We then order the rest of the states by the margin they voted for or against Trump, and keep track of the electoral college votes. One thing to keep in mind is that the electoral college values for different states has changed over time. 

All of this disucssion leads to a natural question: what are the most common tipping point states? We can produce a list of the tipping point state in every election going back to WWII. I matched the electoral college values that I got from [archive.gov](https://www.archives.gov/electoral-college/results
) and [Wikipedia](https://en.wikipedia.org/wiki/United_States_Electoral_College) for each state with the two party vote shares from Lab 1. Using the two party vote shares leads to three issues: in 1948 and 1964 in Alabama, Harry Truman and Lyndon B. Johnson were not included on the ballot meaning the two party vote shares from that year are missing, and the electoral votes were not pledged. Second, it does not account for third party candidates winning electoral votes. The only times this has happened since WWII was Strom Thurmond in 1948 and George Wallace in the 1968 election. For both of these issues, I simply removed those states from the calculation. Third, and most importantly, the margin of victory in the two party vote share may be different from the overall margin of victory when accounting for other candidates. 

In addition, this calculation does not account for states that split electoral votes, like Maine and Nebraska currently do. It also does not account for faithless electors. This calculation *does* account for changing electoral college values over time.

```{r tipping, echo=FALSE,  warning = FALSE}
#read in electoral college data,  clean
ec_values <- read.csv("../Data/ElectoralCollegePost1948_adj.csv")
ec_values <- ec_values[colSums(!is.na(ec_values)) > 0]
ec_values <- na.omit(ec_values)
names(ec_values)[names(ec_values) == "State"] <- "state"
names(ec_values)[names(ec_values) == "Year"] <- "year"

# clean popular vote by state data
pvstate_df[is.na(pvstate_df)] <- 0
pvstate_df <- pvstate_df %>%
  mutate(winner = ifelse(R > D, "republican", "democrat")) %>%
  mutate(win_margin = (R_pv2p-D_pv2p))

# A few rows are lost from 2020 entries and 
# entries from states that didn't exist at the time of the election
tipping_df <- pvstate_df %>% left_join(ec_values, by=c("state","year"))

#tipping state calculation set ups
year_list <- seq(from= 1948, to=2016, by=4)
state_list <- seq(from=1, to=length(year_list), by=1)
threshold_list <- aggregate(tipping_df$EC, by=list(Category=tipping_df$year), FUN=sum) /2 +1

#main loop
for(i in seq(from=1, to=length(year_list),by=1)){
  
  #set year and threshold
  temp_year <- year_list[i]
  threshold <- threshold_list[i,2]
  
  #subset and add column for cumulative EC votes for dems
  dem_wins <- tipping_df %>% filter(winner == 'democrat') %>% filter(year == temp_year)
  dem_wins <- arrange(dem_wins, win_margin)
  dem_wins <- dem_wins %>% mutate(cumsum = cumsum(EC))
  
  #subset and add column for cumulative EC votes for dems
  rep_wins <- tipping_df %>% filter(winner == 'republican') %>% filter(year == temp_year)
  rep_wins <- arrange(rep_wins, -win_margin)
  rep_wins <- rep_wins %>% mutate(cumsum = cumsum(EC))
  
  
  #pick the subset of the winning party
  if (dem_wins[nrow(dem_wins),ncol(dem_wins)]>rep_wins[nrow(rep_wins),ncol(rep_wins)]){
    past_tip <- dem_wins %>% filter(cumsum >= threshold)
  } else {
    past_tip <- rep_wins %>% filter(cumsum >= threshold)
  }
  
  #find tipping point an add to list
  out_tip <- past_tip[1,]
  state_list[i] <- out_tip$state
}

display <- as.data.frame(cbind(state_list,year_list))
names(display)[names(display) == "state_list"] <- "Tipping Point State"
names(display)[names(display) == "year_list"] <- "Election"
display

```






